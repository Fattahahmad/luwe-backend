<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MOORA API Tester - Recipe Recommendation System</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
            }

            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }

            .header p {
                font-size: 1.1em;
                opacity: 0.9;
            }

            .main-content {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0;
                min-height: 70vh;
            }

            .left-panel {
                padding: 30px;
                background: #f8f9fa;
                border-right: 1px solid #e9ecef;
            }

            .right-panel {
                padding: 30px;
                background: #1e1e1e;
                color: #ffffff;
            }

            .section-title {
                font-size: 1.5em;
                margin-bottom: 20px;
                color: #333;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .right-panel .section-title {
                color: #ffffff;
            }

            .form-group {
                margin-bottom: 25px;
            }

            label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #555;
            }

            .ingredient-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 10px;
                max-height: 300px;
                overflow-y: auto;
                border: 1px solid #ddd;
                padding: 15px;
                border-radius: 8px;
                background: white;
            }

            .ingredient-item {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px;
                border-radius: 5px;
                transition: background-color 0.2s;
            }

            .ingredient-item:hover {
                background-color: #f0f0f0;
            }

            .ingredient-item input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
            }

            .ingredient-item label {
                margin: 0;
                cursor: pointer;
                flex: 1;
                font-weight: normal;
            }

            .api-input {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 14px;
                transition: border-color 0.3s;
            }

            .api-input:focus {
                outline: none;
                border-color: #667eea;
            }

            .btn {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 15px 30px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 600;
                transition: transform 0.2s, box-shadow 0.2s;
                width: 100%;
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }

            .btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

            .json-output {
                background: #2d2d2d;
                border: 1px solid #555;
                border-radius: 8px;
                padding: 20px;
                font-family: "Consolas", "Monaco", "Courier New", monospace;
                font-size: 13px;
                line-height: 1.5;
                white-space: pre-wrap;
                overflow-x: auto;
                max-height: 500px;
                overflow-y: auto;
            }

            .status {
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                font-weight: 600;
            }

            .status.loading {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }

            .status.success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .status.error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .quick-select {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                flex-wrap: wrap;
            }

            .quick-btn {
                background: #6c757d;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 20px;
                cursor: pointer;
                font-size: 12px;
                transition: background-color 0.2s;
            }

            .quick-btn:hover {
                background: #5a6268;
            }

            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }

            .stat-card {
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                text-align: center;
            }

            .stat-number {
                font-size: 24px;
                font-weight: bold;
                color: #667eea;
            }

            .stat-label {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
            }

            .response-time {
                color: #28a745;
                font-weight: bold;
            }

            /* JSON Syntax Highlighting */
            .json-key {
                color: #e06c75;
            }
            .json-string {
                color: #98c379;
            }
            .json-number {
                color: #d19a66;
            }
            .json-boolean {
                color: #56b6c2;
            }
            .json-null {
                color: #e5c07b;
            }

            @media (max-width: 1024px) {
                .main-content {
                    grid-template-columns: 1fr;
                }

                .ingredient-grid {
                    grid-template-columns: repeat(
                        auto-fill,
                        minmax(150px, 1fr)
                    );
                }
            }

            @media (max-width: 768px) {
                .container {
                    margin: 10px;
                    border-radius: 10px;
                }

                .header {
                    padding: 20px;
                }

                .header h1 {
                    font-size: 2em;
                }

                .left-panel,
                .right-panel {
                    padding: 20px;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üç≥ MOORA API Tester</h1>
                <p>
                    Test Recipe Recommendation System untuk Flutter Integration
                </p>
            </div>

            <div class="main-content">
                <!-- Left Panel - Input -->
                <div class="left-panel">
                    <div class="section-title">‚öôÔ∏è Configuration</div>

                    <div class="form-group">
                        <label for="apiUrl">API Base URL:</label>
                        <input
                            type="text"
                            id="apiUrl"
                            class="api-input"
                            value="http://localhost/luwe/public/api"
                            placeholder="http://localhost/luwe/public/api"
                        />
                    </div>

                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalIngredients">
                                0
                            </div>
                            <div class="stat-label">Total Ingredients</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="selectedCount">0</div>
                            <div class="stat-label">Selected</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="responseTime">-</div>
                            <div class="stat-label">Response Time</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Quick Select:</label>
                        <div class="quick-select">
                            <button class="quick-btn" onclick="selectRandom(3)">
                                Random 3
                            </button>
                            <button class="quick-btn" onclick="selectRandom(5)">
                                Random 5
                            </button>
                            <button
                                class="quick-btn"
                                onclick="selectRandom(10)"
                            >
                                Random 10
                            </button>
                            <button class="quick-btn" onclick="selectAll()">
                                Select All
                            </button>
                            <button class="quick-btn" onclick="clearAll()">
                                Clear All
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Pilih Bahan yang Tersedia:</label>
                        <div class="ingredient-grid" id="ingredientGrid">
                            <!-- Ingredients will be loaded here -->
                        </div>
                    </div>

                    <button class="btn" id="testBtn" onclick="testMooraAPI()">
                        üöÄ Test MOORA API
                    </button>
                </div>

                <!-- Right Panel - Output -->
                <div class="right-panel">
                    <div class="section-title">üìä JSON Response</div>

                    <div id="statusDiv"></div>

                    <div class="form-group">
                        <div
                            style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 10px;
                            "
                        >
                            <label>JSON Response:</label>
                            <div>
                                <button
                                    onclick="copyToClipboard()"
                                    style="
                                        background: #28a745;
                                        color: white;
                                        border: none;
                                        padding: 8px 12px;
                                        border-radius: 5px;
                                        font-size: 12px;
                                        cursor: pointer;
                                        margin-right: 5px;
                                    "
                                >
                                    üìã Copy JSON
                                </button>
                                <button
                                    onclick="generateFlutterCode()"
                                    style="
                                        background: #007bff;
                                        color: white;
                                        border: none;
                                        padding: 8px 12px;
                                        border-radius: 5px;
                                        font-size: 12px;
                                        cursor: pointer;
                                    "
                                >
                                    üê¶ Flutter Code
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="json-output" id="jsonOutput">
                        <span style="color: #888">
                            üìù Instructions: 1. Pilih bahan-bahan yang tersedia
                            di panel kiri 2. Klik "Test MOORA API" untuk
                            mendapatkan rekomendasi 3. Response JSON akan muncul
                            di sini 4. Copy response untuk testing di Flutter üí°
                            Tips: - Gunakan Quick Select untuk testing cepat -
                            Periksa Response Time untuk performance - Validate
                            JSON structure untuk Flutter integration
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let ingredients = [];
            let startTime;

            // Load ingredients on page load
            document.addEventListener("DOMContentLoaded", function () {
                loadIngredients();
            });

            async function loadIngredients() {
                try {
                    const baseUrl = document.getElementById("apiUrl").value;
                    const response = await fetch(`${baseUrl}/bahans`);

                    if (!response.ok) {
                        throw new Error(
                            `HTTP ${response.status}: ${response.statusText}`
                        );
                    }

                    const data = await response.json();
                    ingredients = data.data || [];

                    displayIngredients();
                    updateStats();

                    showStatus(
                        "success",
                        `Loaded ${ingredients.length} ingredients successfully`
                    );
                } catch (error) {
                    console.error("Error loading ingredients:", error);
                    showStatus(
                        "error",
                        `Failed to load ingredients: ${error.message}`
                    );

                    // Fallback with sample data
                    ingredients = [
                        { id: 1, name: "Bawang merah" },
                        { id: 2, name: "Bawang putih" },
                        { id: 3, name: "Cabai merah" },
                        { id: 4, name: "Garam" },
                        { id: 5, name: "Minyak goreng" },
                    ];
                    displayIngredients();
                    updateStats();
                }
            }

            function displayIngredients() {
                const grid = document.getElementById("ingredientGrid");
                grid.innerHTML = "";

                ingredients.forEach((ingredient) => {
                    const item = document.createElement("div");
                    item.className = "ingredient-item";
                    item.innerHTML = `
                    <input type="checkbox"
                           id="ingredient_${ingredient.id}"
                           value="${ingredient.id}"
                           onchange="updateSelectedCount()">
                    <label for="ingredient_${ingredient.id}">${ingredient.name}</label>
                `;
                    grid.appendChild(item);
                });
            }

            function updateStats() {
                document.getElementById("totalIngredients").textContent =
                    ingredients.length;
                updateSelectedCount();
            }

            function updateSelectedCount() {
                const selected = document.querySelectorAll(
                    '#ingredientGrid input[type="checkbox"]:checked'
                );
                document.getElementById("selectedCount").textContent =
                    selected.length;
            }

            function selectRandom(count) {
                clearAll();

                const checkboxes = document.querySelectorAll(
                    '#ingredientGrid input[type="checkbox"]'
                );
                const shuffled = Array.from(checkboxes).sort(
                    () => 0.5 - Math.random()
                );

                for (let i = 0; i < Math.min(count, shuffled.length); i++) {
                    shuffled[i].checked = true;
                }

                updateSelectedCount();
            }

            function selectAll() {
                const checkboxes = document.querySelectorAll(
                    '#ingredientGrid input[type="checkbox"]'
                );
                checkboxes.forEach((cb) => (cb.checked = true));
                updateSelectedCount();
            }

            function clearAll() {
                const checkboxes = document.querySelectorAll(
                    '#ingredientGrid input[type="checkbox"]'
                );
                checkboxes.forEach((cb) => (cb.checked = false));
                updateSelectedCount();
            }

            async function testMooraAPI() {
                const selectedIds = Array.from(
                    document.querySelectorAll(
                        '#ingredientGrid input[type="checkbox"]:checked'
                    )
                ).map((cb) => parseInt(cb.value));

                if (selectedIds.length === 0) {
                    showStatus(
                        "error",
                        "Please select at least one ingredient"
                    );
                    return;
                }

                const btn = document.getElementById("testBtn");
                btn.disabled = true;
                btn.textContent = "‚è≥ Testing...";

                startTime = performance.now();
                showStatus(
                    "loading",
                    `Testing with ${selectedIds.length} ingredients...`
                );

                try {
                    const baseUrl = document.getElementById("apiUrl").value;
                    const response = await fetch(
                        `${baseUrl}/recommendations/moora`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Accept: "application/json",
                            },
                            body: JSON.stringify({
                                ingredient_ids: selectedIds,
                            }),
                        }
                    );

                    const endTime = performance.now();
                    const responseTime = Math.round(endTime - startTime);
                    document.getElementById(
                        "responseTime"
                    ).textContent = `${responseTime}ms`;
                    document.getElementById("responseTime").className =
                        "response-time";

                    const data = await response.json();

                    if (response.ok) {
                        displayJsonResponse(data);
                        showStatus(
                            "success",
                            `‚úÖ Success! Found ${
                                data.data?.length || 0
                            } recommendations in ${responseTime}ms`
                        );
                    } else {
                        displayJsonResponse(data);
                        showStatus(
                            "error",
                            `‚ùå API Error (${response.status}): ${
                                data.message || "Unknown error"
                            }`
                        );
                    }
                } catch (error) {
                    console.error("Error testing API:", error);
                    showStatus("error", `‚ùå Network Error: ${error.message}`);

                    // Display error in JSON output
                    displayJsonResponse({
                        error: true,
                        message: error.message,
                        type: "NetworkError",
                    });
                } finally {
                    btn.disabled = false;
                    btn.textContent = "üöÄ Test MOORA API";
                }
            }

            function displayJsonResponse(data) {
                const output = document.getElementById("jsonOutput");
                const jsonString = JSON.stringify(data, null, 2);

                // Simple syntax highlighting
                const highlighted = jsonString
                    .replace(/(".*?"):/g, '<span class="json-key">$1</span>:')
                    .replace(
                        /: (".*?")/g,
                        ': <span class="json-string">$1</span>'
                    )
                    .replace(
                        /: (true|false)/g,
                        ': <span class="json-boolean">$1</span>'
                    )
                    .replace(/: (null)/g, ': <span class="json-null">$1</span>')
                    .replace(
                        /: (\d+\.?\d*)/g,
                        ': <span class="json-number">$1</span>'
                    );

                output.innerHTML = highlighted;
            }

            function showStatus(type, message) {
                const statusDiv = document.getElementById("statusDiv");
                statusDiv.className = `status ${type}`;
                statusDiv.textContent = message;

                // Auto hide after 5 seconds for success messages
                if (type === "success") {
                    setTimeout(() => {
                        statusDiv.innerHTML = "";
                        statusDiv.className = "";
                    }, 5000);
                }
            }

            // Copy JSON function
            function copyToClipboard() {
                const output = document.getElementById("jsonOutput");
                const text = output.textContent;

                navigator.clipboard
                    .writeText(text)
                    .then(() => {
                        showStatus("success", "üìã JSON copied to clipboard!");
                    })
                    .catch((err) => {
                        console.error("Failed to copy: ", err);
                        showStatus("error", "Failed to copy to clipboard");
                    });
            }

            // Generate Flutter code
            function generateFlutterCode() {
                const selectedIds = Array.from(
                    document.querySelectorAll(
                        '#ingredientGrid input[type="checkbox"]:checked'
                    )
                ).map((cb) => parseInt(cb.value));

                if (selectedIds.length === 0) {
                    showStatus(
                        "error",
                        "Please select ingredients and test API first"
                    );
                    return;
                }

                const baseUrl = document.getElementById("apiUrl").value;

                const flutterCode = `
// MOORA API Call for Flutter
// Generated from MOORA Tester

import 'dart:convert';
import 'package:http/http.dart' as http;

class MooraApiService {
  static const String baseUrl = '${baseUrl}';

  // Get MOORA recommendations
  static Future<Map<String, dynamic>?> getMooraRecommendations(List<int> ingredientIds) async {
    try {
      final response = await http.post(
        Uri.parse('\$baseUrl/recommendations/moora'),
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
        body: jsonEncode({
          'ingredient_ids': ingredientIds,
        }),
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        return data;
      } else {
        print('Error: \${response.statusCode}');
        print('Response: \${response.body}');
        return null;
      }
    } catch (e) {
      print('Network error: \$e');
      return null;
    }
  }

  // Get available ingredients
  static Future<List<dynamic>?> getIngredients() async {
    try {
      final response = await http.get(
        Uri.parse('\$baseUrl/bahans'),
        headers: {'Accept': 'application/json'},
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        return data['data'];
      } else {
        print('Error loading ingredients: \${response.statusCode}');
        return null;
      }
    } catch (e) {
      print('Network error: \$e');
      return null;
    }
  }
}

// Usage Example:
//
// // Get recommendations
// final recommendations = await MooraApiService.getMooraRecommendations([${selectedIds.join(
                    ", "
                )}]);
// if (recommendations != null && recommendations['success']) {
//   final recipes = recommendations['data'] as List;
//   for (var recipe in recipes) {
//     print('Recipe: \${recipe['title']} - Score: \${recipe['moora_score']}');
//   }
// }
//
// // Get ingredients list
// final ingredients = await MooraApiService.getIngredients();
// if (ingredients != null) {
//   for (var ingredient in ingredients) {
//     print('Ingredient: \${ingredient['name']} (ID: \${ingredient['id']})');
//   }
// }

// Model Classes for Type Safety:

class MooraResponse {
  final bool success;
  final List<Recipe> data;
  final ResponseMetadata metadata;

  MooraResponse({
    required this.success,
    required this.data,
    required this.metadata,
  });

  factory MooraResponse.fromJson(Map<String, dynamic> json) {
    return MooraResponse(
      success: json['success'],
      data: (json['data'] as List).map((item) => Recipe.fromJson(item)).toList(),
      metadata: ResponseMetadata.fromJson(json['metadata']),
    );
  }
}

class Recipe {
  final int id;
  final String title;
  final String description;
  final int cookingTime;
  final String category;
  final double mooraScore;
  final double ingredientMatchPercentage;
  final double timeEfficiencyPercentage;
  final int availableIngredientsCount;
  final int totalIngredientsCount;
  final User user;

  Recipe({
    required this.id,
    required this.title,
    required this.description,
    required this.cookingTime,
    required this.category,
    required this.mooraScore,
    required this.ingredientMatchPercentage,
    required this.timeEfficiencyPercentage,
    required this.availableIngredientsCount,
    required this.totalIngredientsCount,
    required this.user,
  });

  factory Recipe.fromJson(Map<String, dynamic> json) {
    return Recipe(
      id: json['id'],
      title: json['title'],
      description: json['description'],
      cookingTime: json['cooking_time'],
      category: json['category'],
      mooraScore: json['moora_score'].toDouble(),
      ingredientMatchPercentage: json['ingredient_match_percentage'].toDouble(),
      timeEfficiencyPercentage: json['time_efficiency_percentage'].toDouble(),
      availableIngredientsCount: json['available_ingredients_count'],
      totalIngredientsCount: json['total_ingredients_count'],
      user: User.fromJson(json['user']),
    );
  }
}

class User {
  final int id;
  final String name;

  User({required this.id, required this.name});

  factory User.fromJson(Map<String, dynamic> json) {
    return User(id: json['id'], name: json['name']);
  }
}

class ResponseMetadata {
  final int totalEligibleRecipes;
  final int totalRecommended;
  final double thresholdUsed;
  final Map<String, double> weights;

  ResponseMetadata({
    required this.totalEligibleRecipes,
    required this.totalRecommended,
    required this.thresholdUsed,
    required this.weights,
  });

  factory ResponseMetadata.fromJson(Map<String, dynamic> json) {
    return ResponseMetadata(
      totalEligibleRecipes: json['total_eligible_recipes'],
      totalRecommended: json['total_recommended'],
      thresholdUsed: json['threshold_used'].toDouble(),
      weights: Map<String, double>.from(json['weights'].map((k, v) => MapEntry(k, v.toDouble()))),
    );
  }
}

class Ingredient {
  final int id;
  final String name;

  Ingredient({required this.id, required this.name});

  factory Ingredient.fromJson(Map<String, dynamic> json) {
    return Ingredient(id: json['id'], name: json['name']);
  }
}
`;

                displayJsonResponse({
                    flutter_code: flutterCode,
                    note: "Flutter code generated based on current selection",
                    selected_ingredients: selectedIds,
                    api_endpoint: `${baseUrl}/recommendations/moora`,
                });

                showStatus(
                    "success",
                    "üê¶ Flutter code generated! Copy from JSON panel."
                );
            }

            // Add copy button functionality when DOM loaded
            document.addEventListener("DOMContentLoaded", function () {
                loadIngredients(); // Load ingredients on page load
            });
        </script>
    </body>
</html>
